<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Service Charge Accounting</title>
  <style>
    /* Reset and Base Styles */
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #f5f5f5; 
    }
    header {
      background: #007BFF;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .language-switcher button { 
      margin-left: 5px; 
      background: #fff; 
      color: #007BFF; 
      border: none; 
      padding: 5px 10px; 
      cursor: pointer; 
      border-radius: 3px;
    }
    main { padding: 20px; }
    section { 
      margin-bottom: 30px; 
      background: #fff; 
      padding: 20px; 
      border-radius: 5px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    label { 
      display: block; 
      margin-top: 10px; 
      font-weight: bold; 
    }
    input { 
      padding: 5px; 
      margin-bottom: 10px; 
      width: 200px; 
      border: 1px solid #ccc; 
      border-radius: 3px;
    }
    h2, h3 { margin-bottom: 10px; }
    .button { 
      padding: 10px 20px; 
      margin-top: 10px; 
      border: none; 
      border-radius: 3px; 
      background: #007BFF; 
      color: #fff; 
      cursor: pointer; 
    }
    
    /* Global Values Blocks */
    #global-values-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .global-block {
      border: 1px solid #ccc;
      padding: 10px;
      flex: 1;
      min-width: 220px;
      border-radius: 5px;
      background: #fafafa;
    }
    
    /* Apartments Table */
    #apartment-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #apartment-table th, #apartment-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    #apartment-table th {
      background: #f0f0f0;
    }
    
    /* Invoice Styles */
    .invoice {
      border: 1px solid #000;
      padding: 20px;
      margin-bottom: 20px;
    }
    .invoice table {
      width: 100%;
      border-collapse: collapse;
    }
    .invoice th, .invoice td {
      padding: 8px;
      text-align: left;
    }
    .invoice th { border-bottom: 1px solid #000; }
    .invoice hr {
      border: 1px solid #000;
      margin: 10px 0;
    }
    .invoice .total-row td { font-weight: bold; }
	
	.computed-invoice-btn {	
	    background: #bab82d; 
		color: #2d38ba; 
	
	}
    
    /* Modal Styles */
    #modal-overlay {
      display: none;
      position: fixed; 
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    #apartment-form-modal {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 1000;
      max-width: 300px;
      border-radius: 5px;
    }
    
    /* Print Styles */
    @media print {
      header, .button, #add-apartment-btn, #compute-btn, #back-btn, .language-switcher, #add-gas-reading-btn { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <div id="app-title" data-i18n="app_name">Service Charge Accounting</div>
    <div class="language-switcher">
      <button id="lang-en">English</button>
      <button id="lang-de">Deutsch</button>
    </div>
  </header>
  <main>
    <!-- Global Values Section -->
    <section id="global-values">
      <h2 data-i18n="globalValues">Parameters</h2>
      <div id="global-values-container">
        <!-- Gas Block -->
        <div class="global-block" id="gas-block">
          <h3 data-i18n="gas">Gas</h3>
          <label for="gas_total_cost" data-i18n="totalCost">Total Cost (€)</label>
          <input type="number" id="gas_total_cost" step="0.01" min="0">
          <label for="gas_total_consumption" data-i18n="gasTotalConsumption">Total Consumption (m³)</label>
          <input type="number" id="gas_total_consumption" step="0.01" min="0">
          <label for="gas_unit_price" data-i18n="pricePerUnit">Price per Unit (€)</label>
          <input type="number" id="gas_unit_price" step="0.01" data-last-price="0" min="0">
          <label for="gas_fix_percentage" data-i18n="gasFixProportion">Gas Fix Proportion (%)</label>
          <input type="number" id="gas_fix_percentage" step="0.01" min="0" max="100">
          <label for="gas_variable_percentage" data-i18n="gasVariableProportion">Gas Variable Proportion (%)</label>
          <input type="number" id="gas_variable_percentage" step="0.01" min="0" max="100">
        </div>
        <!-- General Electricity Block -->
        <div class="global-block" id="electricity-block">
          <h3 data-i18n="generalElectricity">General Electricity</h3>
          <label for="electricity_total_cost" data-i18n="totalCost">Total Cost (€)</label>
          <input type="number" id="electricity_total_cost" step="0.01" min="0">
          <label for="electricity_total_consumption" data-i18n="electricityTotalConsumption">Total Consumption (kw/h)</label>
          <input type="number" id="electricity_total_consumption" step="0.01" min="0">
          <label for="electricity_unit_price" data-i18n="pricePerUnit">Price per Unit (€)</label>
          <input type="number" id="electricity_unit_price" step="0.01" data-last-price="0" min="0">
        </div>
        <!-- Water Block -->
        <div class="global-block" id="water-block">
          <h3 data-i18n="water">Water</h3>
          <label for="water_total_cost" data-i18n="totalCost">Total Cost (€)</label>
          <input type="number" id="water_total_cost" step="0.01" min="0">
          <label for="water_total_consumption" data-i18n="waterTotalConsumption">Total Consumption (m³)</label>
          <input type="number" id="water_total_consumption" step="0.01" min="0">
          <label for="water_unit_price" data-i18n="pricePerUnit">Price per Unit (€)</label>
          <input type="number" id="water_unit_price" step="0.01" data-last-price="0" min="0">
        </div>
        <!-- Other Costs Block -->
        <div class="global-block" id="other-costs-block">
          <h3 data-i18n="otherCosts">Other Costs</h3>
          <label for="grundsteuer" data-i18n="grundsteuer">Property Tax (total cost in €)</label>
          <input type="number" id="grundsteuer" step="0.01" min="0">
          <label for="muellabfuhr" data-i18n="muellabfuhr">Waste Disposal (total cost in €)</label>
          <input type="number" id="muellabfuhr" step="0.01" min="0">
          <label for="wohngebaeudeversicherung" data-i18n="wohngebaeudeversicherung">Building Insurance (total cost in €)</label>
          <input type="number" id="wohngebaeudeversicherung" step="0.01" min="0">
          <label for="strassenreinigung" data-i18n="strassenreinigung">Street Cleaning (total cost in €)</label>
          <input type="number" id="strassenreinigung" step="0.01" min="0">
          <label for="abwasserkosten" data-i18n="abwasserkosten">Sewage Charges (total cost in €)</label>
          <input type="number" id="abwasserkosten" step="0.01" min="0">
        </div>
      </div>
    </section>

    <!-- Apartments Section -->
    <section id="apartments">
      <h2 data-i18n="apartments">Apartments</h2>
      <table id="apartment-table">
        <thead>
          <tr>
            <th data-i18n="familyName">Family Name</th>
            <th data-i18n="numPersons">Number of Persons</th>
            <th data-i18n="waterCounter">Water Counter Reading</th>
            <th data-i18n="apartmentArea">Apartment Area (m²)</th>
            <th data-i18n="gasConsumption">Gas Consumption (u)</th>
            <!-- Invoice column header replaced with whitespace -->
            <th>&nbsp;</th>
          </tr>
        </thead>
        <tbody id="apartment-list">
          <!-- Apartment rows will be dynamically inserted here -->
        </tbody>
      </table>
      <button id="add-apartment-btn" class="button" data-i18n="addApartment">Add Apartment</button>
    </section>

    <!-- Compute Invoices Section -->
    <section id="compute-invoices">
      <h2 data-i18n="computeInvoices">Invoices</h2>
      <button id="compute-btn" class="button" data-i18n="compute">Compute Invoices</button>
      <!-- Computed invoice buttons will be added here -->
    </section>

    <!-- Invoice Display Section -->
    <section id="invoice-display" style="display: none;">
      <button id="back-btn" class="button" data-i18n="back">Back</button>
      <div id="invoice-content"></div>
    </section>

    <!-- Hidden Apartment Form Modal -->
    <div id="modal-overlay"></div>
    <div id="apartment-form-modal">
      <h3 data-i18n="apartmentDetails">Apartment Details</h3>
      <form id="apartment-form">
        <label for="apartment_name" data-i18n="familyName">Family Name</label>
        <input type="text" id="apartment_name" required>
        <label for="num_persons" data-i18n="numPersons">Number of Persons</label>
        <input type="number" id="num_persons" min="1" required>
        <label for="water_counter" data-i18n="waterCounter">Water Counter Reading</label>
        <input type="number" id="water_counter" step="0.01" min="0" required>
        <label for="apartment_area" data-i18n="apartmentArea">Apartment Area (m²)</label>
        <input type="number" id="apartment_area" step="0.01" min="0" required>
        <div id="gas-readings-container">
          <label data-i18n="gasReadings">Gas Readings (u)</label>
          <div id="gas-readings-list"></div>
          <button type="button" id="add-gas-reading-btn" class="button" data-i18n="addGasReading">Add Gas Reading</button>
        </div>
        <br>
        <button type="submit" class="button" data-i18n="saveApartment">Save Apartment</button>
        <button type="button" id="cancel-apartment-btn" class="button" data-i18n="cancel">Cancel</button>
      </form>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        /***** MULTI-LANGUAGE SETUP *****/
        const translations = {
          en: {
		    app_name: "Service Charge Accounting",
            globalValues: "Parameters",
            gas: "Gas",
            totalCost: "Total Cost (€)",
            gasTotalConsumption: "Total Consumption (m³)",
            pricePerUnit: "Price per Unit (€)",
            gasFixProportion: "Gas Fix Proportion (%)",
            gasVariableProportion: "Gas Variable Proportion (%)",
            generalElectricity: "General Electricity",
            electricityTotalConsumption: "Total Consumption (kw/h)",
            water: "Water",
            waterTotalConsumption: "Total Consumption (m³)",
            otherCosts: "Other Costs",
            grundsteuer: "Property Tax (total cost in €)",
            muellabfuhr: "Waste Disposal (total cost in €)",
            wohngebaeudeversicherung: "Building Insurance (total cost in €)",
            strassenreinigung: "Street Cleaning (total cost in €)",
            abwasserkosten: "Sewage Charges (total cost in €)",
            apartments: "Apartments",
            addApartment: "Add Apartment",
            computeInvoices: "Invoices",
            compute: "Compute Invoices",
            back: "Back",
            apartmentDetails: "Apartment Details",
            familyName: "Family Name",
            numPersons: "Number of Persons",
            waterCounter: "Water Counter Reading",
            apartmentArea: "Apartment Area (m²)",
            gasReadings: "Gas Readings (u)",
            addGasReading: "Add Gas Reading",
            saveApartment: "Save Apartment",
            cancel: "Cancel",
            invoice: "Invoice",
            invoiceHeader: "Invoice for ",
            invoiceHeader_de: "Nebenkostenabrechnung für ",
            item: "Item",
            cost: "Cost (€)",
            total: "Total",
            gasConsumption: "Gas Consumption (u)",
            exportPDF: "Export as PDF"
          },
          de: {
		    app_name: "Nebenkosten Abrechner",
            globalValues: "Parameter",
            gas: "Gas",
            totalCost: "Gesamtkosten (€)",
            gasTotalConsumption: "Gesamtverbrauch (m³)",
            pricePerUnit: "Preis pro Einheit (€)",
            gasFixProportion: "Gas-Fixanteil (%)",
            gasVariableProportion: "Gas-Variabel (%)",
            generalElectricity: "Allgemeiner Strom",
            electricityTotalConsumption: "Gesamtverbrauch (kw/h)",
            water: "Wasser",
            waterTotalConsumption: "Gesamtverbrauch (m³)",
            otherCosts: "Weitere Kosten",
            grundsteuer: "Grundsteuer (Gesamtkosten in €)",
            muellabfuhr: "Müllabfuhr (Gesamtkosten in €)",
            wohngebaeudeversicherung: "Wohngebäudeversicherung (Gesamtkosten in €)",
            strassenreinigung: "Straßenreinigung (Gesamtkosten in €)",
            abwasserkosten: "Abwasserkosten (Gesamtkosten in €)",
            apartments: "Wohnungen",
            addApartment: "Wohnung hinzufügen",
            computeInvoices: "Rechnungen",
            compute: "Berechnen",
            back: "Zurück",
            apartmentDetails: "Wohnungsdetails",
            familyName: "Familienname",
            numPersons: "Anzahl Personen",
            waterCounter: "Wasserzählerstand",
            apartmentArea: "Wohnfläche (m²)",
            gasReadings: "Gaswerte (u)",
            addGasReading: "Gaswert hinzufügen",
            saveApartment: "Wohnung speichern",
            cancel: "Abbrechen",
            invoice: "Rechnung",
            invoiceHeader: "Rechnung für ",
            invoiceHeader_de: "Nebenkostenabrechnung für ",
            item: "Position",
            cost: "Kosten (€)",
            total: "Gesamtsumme",
            gasConsumption: "Gasverbrauch (u)",
            exportPDF: "Als PDF exportieren"
          }
        };

        let currentLang = 'en';

        function updateTranslations() {
          document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(translations[currentLang][key]) {
              el.textContent = translations[currentLang][key];
            }
          });
        }

        function updatePlaceholders() {
          document.querySelectorAll('#gas-readings-list input').forEach(input => {
            input.placeholder = currentLang === 'de' ? "Gaswert (u)" : "Gas reading (u)";
          });
        }

        document.getElementById('lang-en').addEventListener('click', () => {
          currentLang = 'en';
          updateTranslations();
          updatePlaceholders();
          updateApartmentTable();
        });
        document.getElementById('lang-de').addEventListener('click', () => {
          currentLang = 'de';
          updateTranslations();
          updatePlaceholders();
          updateApartmentTable();
        });

        /***** AUTO-CALCULATION FOR GLOBAL UTILITY FIELDS *****/
        function setupAutoCalculation(totalCostId, totalConsumptionId, unitPriceId) {
          const totalCost = document.getElementById(totalCostId);
          const totalConsumption = document.getElementById(totalConsumptionId);
          const unitPrice = document.getElementById(unitPriceId);

          function recalc() {
            const costVal = parseFloat(totalCost.value);
            const consVal = parseFloat(totalConsumption.value);
            const priceVal = parseFloat(unitPrice.value);
            const lastPrice = parseFloat(unitPrice.dataset.lastPrice) || 0;

            // Avoid division by zero; if consumption is zero then try to compute consumption if possible.
            if(consVal === 0 && !isNaN(costVal) && !isNaN(priceVal) && priceVal !== 0) {
              totalConsumption.value = (costVal / priceVal).toFixed(2);
              unitPrice.dataset.lastPrice = priceVal;
              return;
            }
            if(!isNaN(costVal) && !isNaN(consVal) && consVal !== 0) {
              const computedPrice = costVal / consVal;
              // If the unit price has been manually changed (difference from computed price)
              if(!isNaN(priceVal) && Math.abs(computedPrice - lastPrice) < 0.01) {
                totalCost.value = (consVal * priceVal).toFixed(2);
                unitPrice.dataset.lastPrice = priceVal;
              } else {
                unitPrice.value = computedPrice.toFixed(2);
                unitPrice.dataset.lastPrice = computedPrice.toFixed(2);
              }
              return;
            }
            if(!isNaN(costVal) && !isNaN(priceVal) && priceVal !== 0) {
              totalConsumption.value = (costVal / priceVal).toFixed(2);
              unitPrice.dataset.lastPrice = priceVal;
              return;
            }
            if(!isNaN(consVal) && !isNaN(priceVal)) {
              totalCost.value = (consVal * priceVal).toFixed(2);
              unitPrice.dataset.lastPrice = priceVal;
              return;
            }
          }
          totalCost.addEventListener('input', recalc);
          totalConsumption.addEventListener('input', recalc);
          unitPrice.addEventListener('input', recalc);
        }
        setupAutoCalculation('gas_total_cost', 'gas_total_consumption', 'gas_unit_price');
        setupAutoCalculation('electricity_total_cost', 'electricity_total_consumption', 'electricity_unit_price');
        setupAutoCalculation('water_total_cost', 'water_total_consumption', 'water_unit_price');

        // Gas percentage fields – keep their sum at 100
        const gasFix = document.getElementById('gas_fix_percentage');
        const gasVar = document.getElementById('gas_variable_percentage');
        function updateGasPercentages(changedElement) {
          let fixVal = parseFloat(gasFix.value);
          let varVal = parseFloat(gasVar.value);
          if(changedElement === gasFix) {
            if(isNaN(fixVal) || fixVal < 0) fixVal = 0;
            if(fixVal > 100) { fixVal = 100; gasFix.value = 100; }
            gasVar.value = (100 - fixVal).toFixed(2);
          } else if(changedElement === gasVar) {
            if(isNaN(varVal) || varVal < 0) varVal = 0;
            if(varVal > 100) { varVal = 100; gasVar.value = 100; }
            gasFix.value = (100 - varVal).toFixed(2);
          }
        }
        gasFix.addEventListener('input', () => { updateGasPercentages(gasFix); });
        gasVar.addEventListener('input', () => { updateGasPercentages(gasVar); });

        /***** APARTMENT MANAGEMENT *****/
        const apartments = [];

        function showApartmentForm() {
          document.getElementById('apartment-form').reset();
          document.getElementById('gas-readings-list').innerHTML = "";
          addGasReadingField(); // Start with one gas reading field
          document.getElementById('modal-overlay').style.display = 'block';
          document.getElementById('apartment-form-modal').style.display = 'block';
        }

        function hideApartmentForm() {
          document.getElementById('modal-overlay').style.display = 'none';
          document.getElementById('apartment-form-modal').style.display = 'none';
        }

        document.getElementById('add-apartment-btn').addEventListener('click', showApartmentForm);
        document.getElementById('cancel-apartment-btn').addEventListener('click', hideApartmentForm);
        document.getElementById('modal-overlay').addEventListener('click', hideApartmentForm);

        // Add a new gas reading input field
        function addGasReadingField() {
          const container = document.getElementById('gas-readings-list');
          const input = document.createElement('input');
          input.type = 'number';
          input.step = '0.01';
          input.min = '0';
          input.placeholder = currentLang === 'de' ? "Gaswert (u)" : "Gas reading (u)";
          container.appendChild(input);
        }
        document.getElementById('add-gas-reading-btn').addEventListener('click', addGasReadingField);

        // Handle apartment form submission
        document.getElementById('apartment-form').addEventListener('submit', (e) => {
          e.preventDefault();
          const name = document.getElementById('apartment_name').value.trim();
          const numPersons = parseInt(document.getElementById('num_persons').value, 10);
          const waterCounter = parseFloat(document.getElementById('water_counter').value);
          const area = parseFloat(document.getElementById('apartment_area').value);
          if(!name) {
            alert(currentLang === 'de' ? "Bitte geben Sie einen Familiennamen ein." : "Please enter a family name.");
            return;
          }
          if(isNaN(numPersons) || numPersons < 1) {
            alert(currentLang === 'de' ? "Eine Wohnung muss mindestens eine Person haben." : "Apartment must have at least one person.");
            return;
          }
          if(isNaN(waterCounter) || waterCounter < 0) {
            alert(currentLang === 'de' ? "Ungültiger Wasserzählerstand." : "Invalid water counter reading.");
            return;
          }
          if(isNaN(area) || area <= 0) {
            alert(currentLang === 'de' ? "Ungültige Wohnfläche." : "Invalid apartment area.");
            return;
          }
          const gasReadingInputs = document.querySelectorAll('#gas-readings-list input');
          let gasReadings = [];
          gasReadingInputs.forEach(input => {
            const val = parseFloat(input.value);
            if(!isNaN(val) && val >= 0) { gasReadings.push(val); }
          });
          const gasConsumption = gasReadings.reduce((sum, val) => sum + val, 0);
          const apartment = { name, numPersons, waterCounter, area, gasConsumption };
          apartments.push(apartment);
          updateApartmentTable();
          hideApartmentForm();
        });

        // Update the apartment table with in-place editable cells
        function updateApartmentTable() {
          const list = document.getElementById('apartment-list');
          list.innerHTML = "";
          apartments.forEach((apt, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${apt.name}</td>
              <td>${apt.numPersons}</td>
              <td>${apt.waterCounter}</td>
              <td>${apt.area}</td>
              <td>${apt.gasConsumption.toFixed(2)}</td>
              <td><button class="button remove-btn" data-index="${index}">${currentLang === 'de' ? "Entfernen" : "remove"}</button></td>
            `;
            // Make the first five cells editable
            for (let i = 0; i < row.children.length - 1; i++) {
              const cell = row.children[i];
              cell.setAttribute('contenteditable', 'true');
              cell.addEventListener('blur', function() {
                let newValue = cell.innerText.trim();
                let prop;
                switch(i) {
                  case 0: // Family Name (string)
                    prop = 'name';
                    apartments[index][prop] = newValue;
                    break;
                  case 1: // Number of Persons (integer)
                    prop = 'numPersons';
                    const intVal = parseInt(newValue, 10);
                    if (!isNaN(intVal) && intVal >= 1) {
                      apartments[index][prop] = intVal;
                    } else {
                      cell.innerText = apartments[index][prop];
                      alert(currentLang === 'de' ? "Ungültige Anzahl Personen." : "Invalid number of persons.");
                    }
                    break;
                  case 2: // Water Counter (float)
                    prop = 'waterCounter';
                    const waterVal = parseFloat(newValue);
                    if (!isNaN(waterVal) && waterVal >= 0) {
                      apartments[index][prop] = waterVal;
                    } else {
                      cell.innerText = apartments[index][prop];
                      alert(currentLang === 'de' ? "Ungültiger Wasserzählerstand." : "Invalid water counter reading.");
                    }
                    break;
                  case 3: // Apartment Area (float)
                    prop = 'area';
                    const areaVal = parseFloat(newValue);
                    if (!isNaN(areaVal) && areaVal > 0) {
                      apartments[index][prop] = areaVal;
                    } else {
                      cell.innerText = apartments[index][prop];
                      alert(currentLang === 'de' ? "Ungültige Wohnfläche." : "Invalid apartment area.");
                    }
                    break;
                  case 4: // Gas Consumption (float)
                    prop = 'gasConsumption';
                    const gasVal = parseFloat(newValue);
                    if (!isNaN(gasVal) && gasVal >= 0) {
                      apartments[index][prop] = gasVal;
                      cell.innerText = gasVal.toFixed(2);
                    } else {
                      cell.innerText = apartments[index][prop].toFixed(2);
                      alert(currentLang === 'de' ? "Ungültiger Gasverbrauch." : "Invalid gas consumption.");
                    }
                    break;
                }
              });
            }
            list.appendChild(row);
          });
          // Attach event listeners for remove buttons
          document.querySelectorAll('.remove-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const idx = parseInt(e.target.getAttribute('data-index'), 10);
              apartments.splice(idx, 1);
              updateApartmentTable();
            });
          });
        }

        /***** INVOICE CALCULATION *****/
        let invoices = [];
        document.getElementById('compute-btn').addEventListener('click', () => {
          // Parse global utility values
          const gasTotalCost = parseFloat(document.getElementById('gas_total_cost').value);
          const gasTotalConsumption = parseFloat(document.getElementById('gas_total_consumption').value);
          const gasUnitPrice = parseFloat(document.getElementById('gas_unit_price').value);
          const gasFixPercentage = parseFloat(document.getElementById('gas_fix_percentage').value);
          const gasVariablePercentage = parseFloat(document.getElementById('gas_variable_percentage').value);
          const elecTotalCost = parseFloat(document.getElementById('electricity_total_cost').value);
          const elecTotalConsumption = parseFloat(document.getElementById('electricity_total_consumption').value);
          const elecUnitPrice = parseFloat(document.getElementById('electricity_unit_price').value);
          const waterTotalCost = parseFloat(document.getElementById('water_total_cost').value);
          const waterTotalConsumption = parseFloat(document.getElementById('water_total_consumption').value);
          const waterUnitPrice = parseFloat(document.getElementById('water_unit_price').value);
          // Other fixed costs
          const propertyTax = parseFloat(document.getElementById('grundsteuer').value);
          const wasteDisposal = parseFloat(document.getElementById('muellabfuhr').value);
          const buildingInsurance = parseFloat(document.getElementById('wohngebaeudeversicherung').value);
          const streetCleaning = parseFloat(document.getElementById('strassenreinigung').value);
          const sewageCharges = parseFloat(document.getElementById('abwasserkosten').value);

          // Validate global inputs
          if([gasTotalCost, gasTotalConsumption, gasUnitPrice, elecTotalCost, elecTotalConsumption, elecUnitPrice, waterTotalCost, waterTotalConsumption, waterUnitPrice].some(val => isNaN(val))) {
            alert(currentLang === 'de' ? "Bitte füllen Sie alle globalen Werte aus." : "Please fill in all global utility values.");
            return;
          }
          if(apartments.length === 0) {
            alert(currentLang === 'de' ? "Keine Wohnungen vorhanden." : "No apartments available.");
            return;
          }

          const totalPersons = apartments.reduce((sum, apt) => sum + apt.numPersons, 0);
          const totalArea = apartments.reduce((sum, apt) => sum + apt.area, 0);
          const totalWaterCounter = apartments.reduce((sum, apt) => sum + apt.waterCounter, 0);
          const totalGasConsumption = apartments.reduce((sum, apt) => sum + apt.gasConsumption, 0);

          // Avoid division by zero in cost distribution
          const wasteDisposalPerPerson = totalPersons ? wasteDisposal / totalPersons : 0;
          const streetCleaningPerPerson = totalPersons ? streetCleaning / totalPersons : 0;
          const sewageChargesPerPerson = totalPersons ? sewageCharges / totalPersons : 0;
          const electricityPerPerson = totalPersons ? elecTotalCost / totalPersons : 0;
          const buildingInsurancePerSqm = totalArea ? buildingInsurance / totalArea : 0;
          const propertyTaxPerSqm = totalArea ? propertyTax / totalArea : 0;

          const waterCostFromCounters = totalWaterCounter * waterUnitPrice;
          let extraWaterCostPerPerson = 0;
          if(waterTotalCost > waterCostFromCounters && totalPersons) {
            extraWaterCostPerPerson = (waterTotalCost - waterCostFromCounters) / totalPersons;
          }
          // Gas: compute variable and fixed costs
          const gasVariableCostTotal = gasTotalCost * (gasVariablePercentage / 100);
          const gasFixCostTotal = gasTotalCost * (gasFixPercentage / 100);
          const gasVariableCostPerM3 = totalGasConsumption ? (gasVariableCostTotal / totalGasConsumption) : 0;
          const gasFixCostPerSqm = totalArea ? (gasFixCostTotal / totalArea) : 0;

          invoices = apartments.map(apt => {
            const items = [];
            const aptWaste = wasteDisposalPerPerson * apt.numPersons;
            items.push({ name: currentLang === 'de' ? "Müllabfuhr" : "Waste Disposal", cost: aptWaste });
            const aptInsurance = buildingInsurancePerSqm * apt.area;
            items.push({ name: currentLang === 'de' ? "Wohngebäudeversicherung" : "Building Insurance", cost: aptInsurance });
            const aptPropertyTax = propertyTaxPerSqm * apt.area;
            items.push({ name: currentLang === 'de' ? "Grundsteuer" : "Property Tax", cost: aptPropertyTax });
            const aptStreet = streetCleaningPerPerson * apt.numPersons;
            items.push({ name: currentLang === 'de' ? "Straßenreinigung" : "Street Cleaning", cost: aptStreet });
            const aptSewage = sewageChargesPerPerson * apt.numPersons;
            items.push({ name: currentLang === 'de' ? "Abwasserkosten" : "Sewage Charges", cost: aptSewage });
            const aptElectricity = electricityPerPerson * apt.numPersons;
            items.push({ name: currentLang === 'de' ? "Allgemeiner Strom" : "General Electricity", cost: aptElectricity });
            let aptWater = apt.waterCounter * waterUnitPrice;
            aptWater += extraWaterCostPerPerson * apt.numPersons;
            items.push({ name: currentLang === 'de' ? "Wasser" : "Water", cost: aptWater });
            const aptGasVar = gasVariableCostPerM3 * apt.gasConsumption;
            items.push({ name: currentLang === 'de' ? "Gas (variabel)" : "Gas (variable)", cost: aptGasVar });
            const aptGasFix = gasFixCostPerSqm * apt.area;
            items.push({ name: currentLang === 'de' ? "Gas (fix)" : "Gas (fixed)", cost: aptGasFix });
            const aptGasTotal = aptGasVar + aptGasFix;
            items.push({ name: currentLang === 'de' ? "Gas (gesamt)" : "Gas (total)", cost: aptGasTotal, infoOnly: true });
            const invoiceTotal = items.reduce((sum, it) => (!it.infoOnly ? sum + it.cost : sum), 0);
            return { apartment: apt, items, total: invoiceTotal };
          });

          alert(currentLang === 'de' ? "Rechnungen wurden berechnet." : "Invoices have been computed.");

          // --- NEW: Create computed invoice buttons in the compute-invoices section ---  
          let computedInvoiceList = document.getElementById('computed-invoice-list');
          if (!computedInvoiceList) {
              computedInvoiceList = document.createElement('div');
              computedInvoiceList.id = 'computed-invoice-list';
              document.getElementById('compute-invoices').appendChild(computedInvoiceList);
          } else {
              computedInvoiceList.innerHTML = "";
          }
          invoices.forEach((invoice, index) => {
              const btn = document.createElement('button');
              btn.textContent = invoice.apartment.name;
              btn.style.display = 'block';
              btn.style.width = '100%';
              btn.className = 'computed-invoice-btn button';
              btn.addEventListener('click', () => {
                  showInvoice(index);
              });
              computedInvoiceList.appendChild(btn);
          });
        });

        /***** DISPLAYING THE INVOICE *****/
        function showInvoice(index) {
          const invoice = invoices[index];
          if(!invoice) {
            alert(currentLang === 'de' ? "Rechnung nicht verfügbar. Bitte zuerst berechnen." : "Invoice not available. Please compute invoices first.");
            return;
          }
          document.getElementById('global-values').style.display = 'none';
          document.getElementById('apartments').style.display = 'none';
          document.getElementById('compute-invoices').style.display = 'none';
          document.getElementById('invoice-display').style.display = 'block';

          const content = document.getElementById('invoice-content');
          content.innerHTML = "";
          const invDiv = document.createElement('div');
          invDiv.className = 'invoice';
          const header = document.createElement('h2');
          header.textContent = (currentLang === 'de' ? translations[currentLang].invoiceHeader_de : translations[currentLang].invoiceHeader) + invoice.apartment.name;
          invDiv.appendChild(header);

          const table = document.createElement('table');
          const tbody = document.createElement('tbody');
          invoice.items.forEach(it => {
            const row = document.createElement('tr');
            const tdName = document.createElement('td');
            tdName.textContent = it.name;
            const tdCost = document.createElement('td');
            // For info-only item (Gas total), show in parentheses
            if (it.infoOnly) {
              tdCost.textContent = "(" + it.cost.toFixed(2) + ")";
            } else {
              tdCost.textContent = it.cost.toFixed(2) + "  €";
            }
            row.appendChild(tdName);
            row.appendChild(tdCost);
            tbody.appendChild(row);
          });
          // Horizontal line row
          const lineRow = document.createElement('tr');
          const lineCell = document.createElement('td');
          lineCell.colSpan = 2;
          const hr = document.createElement('hr');
          lineCell.appendChild(hr);
          lineRow.appendChild(lineCell);
          tbody.appendChild(lineRow);
          // Blank row
          const blankRow = document.createElement('tr');
          blankRow.innerHTML = `<td colspan="2">&nbsp;</td>`;
          tbody.appendChild(blankRow);
          // Total row in bold
          const totalRow = document.createElement('tr');
          totalRow.className = 'total-row';
          const tdLabel = document.createElement('td');
          tdLabel.textContent = translations[currentLang].total;
          const tdTotal = document.createElement('td');
          tdTotal.textContent = invoice.total.toFixed(2) + "  €";
          totalRow.appendChild(tdLabel);
          totalRow.appendChild(tdTotal);
          tbody.appendChild(totalRow);
          table.appendChild(tbody);
          invDiv.appendChild(table);
          // Export as PDF button (triggers print)
          const pdfBtn = document.createElement('button');
          pdfBtn.className = 'button';
          pdfBtn.textContent = translations[currentLang].exportPDF;
          pdfBtn.addEventListener('click', () => { window.print(); });
          invDiv.appendChild(pdfBtn);
          content.appendChild(invDiv);
        }

        document.getElementById('back-btn').addEventListener('click', () => {
          document.getElementById('global-values').style.display = 'block';
          document.getElementById('apartments').style.display = 'block';
          document.getElementById('compute-invoices').style.display = 'block';
          document.getElementById('invoice-display').style.display = 'none';
        });

        updateTranslations();
		

/***** DATA PERSISTENCE WITH LOCALSTORAGE *****/
// Save all application data to localStorage
function saveAppData() {
  // Save global parameters
  const globalParams = {
    gas: {
      totalCost: document.getElementById('gas_total_cost').value,
      totalConsumption: document.getElementById('gas_total_consumption').value,
      unitPrice: document.getElementById('gas_unit_price').value,
      fixPercentage: document.getElementById('gas_fix_percentage').value,
      variablePercentage: document.getElementById('gas_variable_percentage').value
    },
    electricity: {
      totalCost: document.getElementById('electricity_total_cost').value,
      totalConsumption: document.getElementById('electricity_total_consumption').value,
      unitPrice: document.getElementById('electricity_unit_price').value
    },
    water: {
      totalCost: document.getElementById('water_total_cost').value,
      totalConsumption: document.getElementById('water_total_consumption').value,
      unitPrice: document.getElementById('water_unit_price').value
    },
    otherCosts: {
      grundsteuer: document.getElementById('grundsteuer').value,
      muellabfuhr: document.getElementById('muellabfuhr').value,
      wohngebaeudeversicherung: document.getElementById('wohngebaeudeversicherung').value,
      strassenreinigung: document.getElementById('strassenreinigung').value,
      abwasserkosten: document.getElementById('abwasserkosten').value
    },
    language: currentLang
  };
  
  // Save data to localStorage
  localStorage.setItem('serviceChargeGlobalParams', JSON.stringify(globalParams));
  localStorage.setItem('serviceChargeApartments', JSON.stringify(apartments));
  
  // Save timestamp for debugging/display purposes
  localStorage.setItem('serviceChargeLastSaved', new Date().toISOString());
}

// Load application data from localStorage
function loadAppData() {
  try {
    // Load global parameters
    const globalParams = JSON.parse(localStorage.getItem('serviceChargeGlobalParams'));
    if (globalParams) {
      // Set language first to ensure proper display
      if (globalParams.language) {
        currentLang = globalParams.language;
        updateTranslations();
      }
      
      // Set gas values
      if (globalParams.gas) {
        document.getElementById('gas_total_cost').value = globalParams.gas.totalCost || '';
        document.getElementById('gas_total_consumption').value = globalParams.gas.totalConsumption || '';
        document.getElementById('gas_unit_price').value = globalParams.gas.unitPrice || '';
        document.getElementById('gas_unit_price').dataset.lastPrice = globalParams.gas.unitPrice || '0';
        document.getElementById('gas_fix_percentage').value = globalParams.gas.fixPercentage || '';
        document.getElementById('gas_variable_percentage').value = globalParams.gas.variablePercentage || '';
      }
      
      // Set electricity values
      if (globalParams.electricity) {
        document.getElementById('electricity_total_cost').value = globalParams.electricity.totalCost || '';
        document.getElementById('electricity_total_consumption').value = globalParams.electricity.totalConsumption || '';
        document.getElementById('electricity_unit_price').value = globalParams.electricity.unitPrice || '';
        document.getElementById('electricity_unit_price').dataset.lastPrice = globalParams.electricity.unitPrice || '0';
      }
      
      // Set water values
      if (globalParams.water) {
        document.getElementById('water_total_cost').value = globalParams.water.totalCost || '';
        document.getElementById('water_total_consumption').value = globalParams.water.totalConsumption || '';
        document.getElementById('water_unit_price').value = globalParams.water.unitPrice || '';
        document.getElementById('water_unit_price').dataset.lastPrice = globalParams.water.unitPrice || '0';
      }
      
      // Set other costs
      if (globalParams.otherCosts) {
        document.getElementById('grundsteuer').value = globalParams.otherCosts.grundsteuer || '';
        document.getElementById('muellabfuhr').value = globalParams.otherCosts.muellabfuhr || '';
        document.getElementById('wohngebaeudeversicherung').value = globalParams.otherCosts.wohngebaeudeversicherung || '';
        document.getElementById('strassenreinigung').value = globalParams.otherCosts.strassenreinigung || '';
        document.getElementById('abwasserkosten').value = globalParams.otherCosts.abwasserkosten || '';
      }
    }
    
    // Load apartments
    const savedApartments = JSON.parse(localStorage.getItem('serviceChargeApartments'));
    if (savedApartments && Array.isArray(savedApartments)) {
      // Clear current apartments and replace with saved ones
      apartments.length = 0;
      savedApartments.forEach(apt => apartments.push(apt));
      updateApartmentTable();
    }
    
    console.log('Data loaded from localStorage successfully');
  } catch (error) {
    console.error('Error loading data from localStorage:', error);
  }
}

// Add event listeners to save data on changes
function setupPersistenceListeners() {
  // Add listeners to all global input fields
  const globalInputIds = [
    'gas_total_cost', 'gas_total_consumption', 'gas_unit_price', 
    'gas_fix_percentage', 'gas_variable_percentage',
    'electricity_total_cost', 'electricity_total_consumption', 'electricity_unit_price',
    'water_total_cost', 'water_total_consumption', 'water_unit_price',
    'grundsteuer', 'muellabfuhr', 'wohngebaeudeversicherung', 'strassenreinigung', 'abwasserkosten'
  ];
  
  globalInputIds.forEach(id => {
    document.getElementById(id).addEventListener('change', saveAppData);
  });
  
  // Save when language changes
  document.getElementById('lang-en').addEventListener('click', saveAppData);
  document.getElementById('lang-de').addEventListener('click', saveAppData);
  
  // Save after apartment updates (Adding/editing/removing apartments)
  const originalUpdateApartmentTable = updateApartmentTable;
  updateApartmentTable = function() {
    originalUpdateApartmentTable();
    saveAppData();
  };
  
  // Save when the apartment form is submitted
  const apartmentForm = document.getElementById('apartment-form');
  const originalSubmitHandler = apartmentForm.onsubmit;
  apartmentForm.addEventListener('submit', function(e) {
    if (originalSubmitHandler) {
      originalSubmitHandler(e);
    }
    saveAppData();
  });
}

// Add a "Reset All Data" button to the UI
function addResetButton() {
  const resetButton = document.createElement('button');
  resetButton.textContent = currentLang === 'de' ? 'Alle Daten zurücksetzen' : 'Reset All Data';
  resetButton.className = 'button';
  resetButton.style.backgroundColor = '#dc3545';
  resetButton.style.color = 'white';
  resetButton.style.float = 'right';
  resetButton.addEventListener('click', function() {
    if (confirm(currentLang === 'de' ? 
                'Sind Sie sicher, dass Sie alle Daten löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden.' : 
                'Are you sure you want to clear all data? This cannot be undone.')) {
      localStorage.removeItem('serviceChargeGlobalParams');
      localStorage.removeItem('serviceChargeApartments');
      localStorage.removeItem('serviceChargeLastSaved');
      location.reload();
    }
  });
  document.querySelector('header').appendChild(resetButton);
  
  // Update button text when language changes
  const updateResetButton = function() {
    resetButton.textContent = currentLang === 'de' ? 'Alle Daten zurücksetzen' : 'Reset All Data';
  };
  
  document.getElementById('lang-en').addEventListener('click', updateResetButton);
  document.getElementById('lang-de').addEventListener('click', updateResetButton);
}

// Initialize persistence
function initializePersistence() {
  loadAppData();
  setupPersistenceListeners();
  addResetButton();
}

// Call the initialization function after all other initialization
initializePersistence();
		
      });
    </script>
  </main>
</body>
</html>
